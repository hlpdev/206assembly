name: Build and Release ASM206

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build on Windows
        if: runner.os == 'Windows'
        run: |
          gcc -O2 assembler.c -o assembler.exe
          gcc -O2 emulator.c -o emulator.exe
          tar -czvf windows.zip assembler.exe emulator.exe

      - name: Build on Linux
        if: runner.os == 'Linux'
        run: |
          gcc -O2 assembler.c -o assembler
          gcc -O2 emulator.c -o emulator
          chmod +x assembler emulator
          tar -czvf linux.tar.gz assembler emulator

      - name: Build on macOS
        if: runner.os == 'macOS'
        run: |
          gcc -O2 assembler.c -o assembler
          gcc -O2 emulator.c -o emulator
          chmod +x assembler emulator
          tar -czvf macos.tar.gz assembler emulator

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/heads/')
        with:
          tag_name: latest
          name: Latest Release
          files: |
            windows.zip
            linux.tar.gz
            macos.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
